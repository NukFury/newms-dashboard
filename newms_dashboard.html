<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>NEWMS Web Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body{font-family: Arial, Helvetica, sans-serif; max-width:900px;margin:20px auto;}
    .card{border-radius:8px;padding:16px;margin:12px 0;box-shadow:0 2px 6px rgba(0,0,0,0.12);}
    .row{display:flex;gap:12px;flex-wrap:wrap;}
    .col{flex:1;min-width:220px;}
    h1{margin:0 0 8px 0;}
    .value{font-size:28px;font-weight:700;}
    .btn{padding:10px 16px;border-radius:6px;border:0;cursor:pointer;}
  </style>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
  <h1>NEWMS Web Dashboard</h1>

  <div class="card">
    <div class="row">
      <div class="col">
        <div>Temperature</div>
        <div id="temp" class="value">-- °C</div>
      </div>
      <div class="col">
        <div>Humidity</div>
        <div id="hum" class="value">-- %</div>
      </div>
      <div class="col">
        <div>Pressure</div>
        <div id="pres" class="value">-- hPa</div>
      </div>
      <div class="col">
        <div>Altitude</div>
        <div id="alt" class="value">-- m</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div><strong>LED Control</strong></div>
      <div>
        <button id="ledOn" class="btn">Turn ON</button>
        <button id="ledOff" class="btn">Turn OFF</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div>Status: <span id="status">disconnected</span></div>
  </div>

<script>
  // --- CONFIG: use your HiveMQ WebSocket endpoint and credentials ---
  const host = "e1bf1fc970844046bc62def2d86789c0.s1.eu.hivemq.cloud";
  const wsPort = 8884; // HiveMQ Cloud websockets TLS port
  const username = "esp32_client";
  const password = "Esp123456";

  const mqttUrl = `wss://${host}:${wsPort}/mqtt`;

  const client = mqtt.connect(mqttUrl, {
    username: username,
    password: password,
    reconnectPeriod: 2000,
    connectTimeout: 30 * 1000,
    clean: true
  });

  const topicTemp = "newms/weather/temperature";
  const topicHum  = "newms/weather/humidity";
  const topicPres = "newms/weather/pressure";
  const topicAlt  = "newms/weather/altitude";
  const topicLed  = "newms/device/led";
  const topicStatus = "newms/device/status";

  const elTemp = document.getElementById('temp');
  const elHum  = document.getElementById('hum');
  const elPres = document.getElementById('pres');
  const elAlt  = document.getElementById('alt');
  const elStatus = document.getElementById('status');

  client.on('connect', function () {
    elStatus.textContent = 'connected';
    client.subscribe([topicTemp, topicHum, topicPres, topicAlt, topicStatus], function(err) {
      if (!err) console.log('subscribed to topics');
    });
  });

  client.on('reconnect', () => elStatus.textContent = 'reconnecting');
  client.on('disconnect', () => elStatus.textContent = 'disconnected');
  client.on('error', (err) => {
    console.error('MQTT error', err);
    elStatus.textContent = 'error';
  });

  client.on('message', function (topic, message) {
    const m = message.toString();
    if (topic === topicTemp) elTemp.textContent = m + ' °C';
    if (topic === topicHum)  elHum.textContent  = m + ' %';
    if (topic === topicPres) elPres.textContent = m + ' hPa';
    if (topic === topicAlt)  elAlt.textContent  = m + ' m';
    if (topic === topicStatus) console.log('status:', m);
  });

  // Buttons
  document.getElementById('ledOn').addEventListener('click', () => {
    client.publish(topicLed, 'ON');
  });
  document.getElementById('ledOff').addEventListener('click', () => {
    client.publish(topicLed, 'OFF');
  });
</script>
</body>
</html>
